#!/bin/bash
# With this script you can manage and run Windows games via Proton.
# Can be executed either by running ./GameExec directly from the terminal or by running GameExec.desktop from a file manager.
#  Remember to edit the script's path in GameExec.desktop if you plan to move it to a different directory from GameExec.
# Known issues: Sometimes script crashes while trying to launch the game through GameExec.desktop. Prefer running directly from GameExec.

echo "$(echo $'\n\r')#### Linux Game Launcher - by Perseus ####"

script=$(realpath "$0")
scriptpath=$(dirname "$script")
config="$scriptpath/GameExec.conf"
gamelist="$scriptpath/GameList.txt"
if [ -f "$config" ]; then
protonbottle=$(grep "ProtonBottle" "$config" | cut -d "=" -f 2)
protonexec=$(grep "ProtonExec" "$config" | cut -d "=" -f 2)
[ ! -z "$protonexec" ] && protoninstalled=$(dirname "$protonexec" | xargs basename)
fi

# Output in zenity
function output {
  # --timeout 30 kills both steam and game and --progress stays alive until cancel is pressed without it
  #[[ "$param" != "--question" || "$param" != "--info" ]] && unset param2
  [ ! -z "$msg" ] && msg="--text=$msg" && param="$param --no-wrap"
  zenity $param "$msg"
}

# add game function
function addgame {
 gamename=$(zenity --entry --text="Enter new game name:" --width=300)
 [ "$?" -ne 0 ] && param="--error" && msg="Cancelled." && output && desktopmenu
 [ -z "$gamename" ] && param="--error" && msg="Input cannot be empty." && output && desktopmenu
 gamepath=$(zenity --file-selection --title="Select a game executable" --filename "${HOME}/" --file-filter="*.exe")
 [ "$?" -ne 0 ] && param="--error" && msg="Cancelled." && output && desktopmenu
 echo "${gamename}=${gamepath}" >> "$gamelist"
 param="--info" && msg="Success. $gamename added to ${gamelist}." && output
 desktopmenu
}

# games list function
function gameslist {
 [ ! -f "$gamelist" ] && param="--error" && msg="Game list not found. Add games first and retry." && output && desktopmenu
 declare -A games
 while IFS= read -r i; do
  games["$(echo $i | cut -d '=' -f 1)"]="$(echo $i | cut -d '=' -f 2)"
 done < "$gamelist"
 #done < <(sed -r -e 's/([0-9]+)/ \1/' $gamelist | sort -k 2 -n | sed -e 's/ //;')

 selectedgame=$(zenity --list --title="Games" --text="Select a game to $action:" --column="Game" "${!games[@]}" --height=300 --width=500)
 [[ "$?" -ne 0 || -z "$selectedgame" ]] && desktopmenu
 selectedgamepath="${games[$selectedgame]}"
}

# remove game function
function removegame {
 action="remove"
 gameslist
 param="--question" && msg="Are you sure you want to remove ${selectedgame} from the game list?" && output
 [ "$?" -ne 0 ] && param="--info" && msg="Game removal cancelled." && output && desktopmenu
 sed -i "/$selectedgame/d" "$gamelist" && param="--info" && msg="Removed: $selectedgame" && output && desktopmenu
}

function runwinetricks {
  [ -z $(whereis winetricks | awk '{print $2}') ] && param="--error" && msg="winetricks not found installed. Install winetricks and retry." && output && desktopmenu
  [ -z $(whereis wine | awk '{print $2}') ] && param="--error" && msg="wine not found installed. Install wine and retry." && output && desktopmenu
 WINEPREFIX="${protonbottle}/pfx" winetricks
 desktopmenu
}

# reset to default function
function reset {
 param="--question" && msg="This option will reset GameExec to default.\nIt will remove your Proton bottle: $protonbottle.\nand your config file: ${config}.\nYour game list will remain in tact.\nDo you want to proceed?" && output
 [ "$?" -ne 0 ] && param="--info" && msg="Reset cancelled." && output && desktopmenu
 [ -d "$protonbottle" ] && rm -rf "$protonbottle" && rm "$config" && param="--info" && msg="Proton bottle removed: ${protonbottle}.\nConfig removed: ${config}\nRestart the script to initialize new ones. Exiting." && output
 exit 0
}

# launch game function
function launchgame {
 action="launch"
 gameslist
# Experimental vulkan renderer.
 #export RADV_PERFTEST=aco && \
 STEAM_COMPAT_DATA_PATH="$protonbottle" "$protonexec" run "$selectedgamepath" &
 #sleep 5 && pgrep $(basename "$selectedgamepath") >/dev/null && \
  echo "Launching ${selectedgame}..." ; echo "GameExec exits and Proton takes over. Watch the terminal for any errors."
  #zenity --progress --pulsate --auto-close --auto-kill --text="Launching ${selectedgame}..."
# TEMPORARILY REMOVED PROCESS VERIFICATION
 #[ "$?" != 0 ] && param="--error" && \
  #msg="Game execution failed." && output && exit 1
}

# main menu function
function desktopmenu {
selectedmenuitem=$(zenity --list --radiolist --text="Linux Game Launcher - Main menu" \
 --column="Select" --column="Operation" TRUE "Launch a game" FALSE "Add a new game" \
 FALSE "Remove a game from the game list" FALSE "Winetricks (Requires wine and winetricks)" FALSE "Reset GameExec" --height=300 --width=500)

grep -q ^Launch <<<"$selectedmenuitem" && launchgame
grep -q ^Add <<<"$selectedmenuitem" && addgame
grep -q ^Remove <<<"$selectedmenuitem" && removegame
grep -q ^Winetricks <<<"$selectedmenuitem" && runwinetricks
grep -q ^Reset <<<"$selectedmenuitem" && reset
echo "$(echo $'\n\r')#### Linux Game Launcher Finished. ####"
exit 0
#[[ "$?" != 0 || -z "$selectedmenuitem" ]] && param="--question" && msg="Are you sure you want to exit?" --------
}

# Drop error if zenity is not installed
[ -z "$(whereis zenity | awk '{print $2}')" ] && \
 echo "zenity was not found installed. Install zenity and try again. Exiting." && exit 1

# Drop error if steam is not installed
[ -z "$(whereis steam | awk '{print $2}')" ] && \
 param="--error" && msg="Steam cannot be found installed. Install Steam and try again. Exiting." && output && exit 1

# Check if Steam is running
function chk {
 pgrep steam >/dev/null
}

chk || (param="--question" && msg="Steam is not running. Run now?" && output)
if [ "$?" -ne 0 ]; then
 param="--error" && msg="WARNING: You can only run games which don't require Steam to run." && output
else
 chk || steam &
 chk || (param="--info" && msg="Starting Steam...\n(Press OK only after you have logged in on Steam)" && output)
 #chk || (param="--error" && msg="Steam still not running. Exiting." && output && exit 1)
fi

# Check if Proton is installed and also check for update
compatpath="${HOME}/.steam/root/compatibilitytools.d"
protonurl="https://github.com$(curl -s -L https://github.com/GloriousEggroll/proton-ge-custom/releases/latest | grep 'tar.gz' | head -1 | cut -d '"' -f 2)"
protonfile=$(basename "$protonurl")
protondir="${protonfile/.tar.gz/}"
protonfullpath="${compatpath}/${protondir}"
protononline="$protondir"
[ ! -z "$protoninstalled" ] && [ ! -z "$protononline" ] && [ "$protoninstalled" != "$protononline" ] && \
 param="--question" && msg="An updated version of Proton is available online: ${protononline}. \nWould you like to update it now?" && output && \
  [ "$?" -eq 0 ] && updateproton=1

# Drop error if Proton not installed and offer auto install or update
if [ ! -f "$protonexec" ] || [ ! -z "$updateproton" ]; then
 [ ! -f "$protonexec" ] && param="--question" && msg="Proton not found installed or not configured. \nWould you like to verify or install it now?" && output && \
  [ "$?" -ne 0 ] && param="--error" && msg="Cannot start without Proton installed. Exiting." && output && exit 1
# ADD ZENITY PROGRESS HERE
 echo "Installing $protononline..."
 [ ! -z "$updateproton" ] && printf "Cleaning previously installed Proton..." && rm -rf "${compatpath}/${protoninstalled}" && echo "Done."
 mkdir -p "$compatpath" && \
  curl -L "${protonurl}" -o "${compatpath}/Proton.tar.gz" && \
  printf "Uncompressing..." && \
  rm -rf "$protonfullpath" 2>/dev/null && \
  tar xfz "${compatpath}/Proton.tar.gz" --directory "${compatpath}/" && \
  rm "${compatpath}/Proton.tar.gz" && \
  echo "Done." && \
  [ -f "$protonexec" ] && \
  protonexec="${protonfullpath}/proton" && \
  param="--info" && msg="$protondir is now installed." && output
else
 [ ! -f "$config" ] && param="--info" && msg="$protondir found installed and will be added to the config." && output || echo
fi

# Creating config file if not found
if [ ! -f "$config" ]; then
 msg="Select an existing bottle or create an empty directory to make a new Proton bottle."
 param="--info" && msg="Config not found. Creating new config... \n${msg} " && output
 echo "ProtonExec=${protonexec}" > "$config"
 while true; do
  protonbottle=$(zenity --file-selection --title="$msg" --directory --filename "${HOME}/")
  echo "Directory selected: $protonbottle"
  [ -d "$protonbottle" ] && echo "ProtonBottle=${protonbottle}" >> "$config" && \
   param="--info" && msg="$config config is successfully created." && output && break
  param="--error" && msg="This is not a correct directory for Proton Bottle. \nTry again." && output
 done
fi

echo
desktopmenu
